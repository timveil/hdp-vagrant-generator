# -*- mode: ruby -*-
# vi: set ft=ruby :

# generated by https://github.com/timveil/hdp-vagrant-generator on {{generatedDate}}

require 'ffi'

Vagrant.configure("2") do |config|
    config.vm.box = "timveil/centos7-hdp-base"
    config.vm.box_check_update = true

    # configure VM
    # config.vm.hostname is broken in vagrant 1.9.0; works in 1.9.1; broken in 1.9.2 (windows); broken 1.9.3 (mac); broken in 1.9.6 (windows); works 1.9.7 (mac)
    config.vm.hostname = '{{arguments.fqdn}}'
    config.vm.network "private_network", ip: '{{arguments.ip}}'
    config.vm.provider "virtualbox" do |v|
        v.memory = {{arguments.memory}}
        v.cpus = {{arguments.cores}}
        v.name = '{{arguments.fqdn}}'
    end

    if FFI::Platform::IS_MAC
        # configure host updater plugin - https://github.com/cogitatio/vagrant-hostsupdater
        config.hostsupdater.aliases = ["{{arguments.hostname}}"]

        # configure VirtualBox Guest Additions plugin - https://github.com/dotless-de/vagrant-vbguest
        config.vbguest.auto_update = true
        config.vbguest.no_remote = true
        config.vbguest.no_install = false
    end

    # workaround for https://github.com/mitchellh/vagrant/issues/8096; impacts 1.9.1
    config.vm.provision "shell", inline: "service network restart", run: "always"

    # provision VM
    config.vm.provision "file", source: "hosts", destination: "/tmp/install/hosts"
    config.vm.provision "file", source: "blueprint.json", destination: "/tmp/install/blueprint.json"
    config.vm.provision "file", source: "create-cluster.json", destination: "/tmp/install/create-cluster.json"
    {{#arguments.customRepoEnabled}}
    config.vm.provision "file", source: "create-hdp-repo.json", destination: "/tmp/install/create-hdp-repo.json"
    config.vm.provision "file", source: "create-hdp-utils-repo.json", destination: "/tmp/install/create-hdp-utils-repo.json"
    {{/arguments.customRepoEnabled}}
    {{#arguments.kerberosEnabled}}
    config.vm.provision "file", source: "kadm5.acl", destination: "/tmp/install/kadm5.acl"
    config.vm.provision "file", source: "kdc.conf", destination: "/tmp/install/kdc.conf"
    config.vm.provision "file", source: "krb5.conf", destination: "/tmp/install/krb5.conf"
    {{/arguments.kerberosEnabled}}
    config.vm.provision "Install", type: "shell", path: "install.sh"
    config.vm.provision "Ambari Details", type: "shell", inline: "echo 'Ambari URL is http://{{arguments.fqdn}}:8080 or http://{{arguments.hostname}}:8080 or http://{{arguments.ip}}:8080'", run: "always"
end
